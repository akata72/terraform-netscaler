#NS12.1 Build 49.24
# Last modified by `save config`, Thu Nov 15 14:06:59 2018
set ns config -IPAddress 10.78.226.212 -netmask 255.255.255.240
#
enable ns feature WL LB CS SSL SSLVPN AAA RESPONDER CH RDPProxy
enable ns mode MBF USNIP PMTUD
#
set system parameter -doppler DISABLED
set system user nsroot 2ba0d370ddce80c0b1af9018dc7c5109920dbdfce0ef910e19d2edb7b3c3e5e62af9f07383bd68f9ba7fd82329f1ce0176861cc5d00e7d8c89080861e574434ba3de22eec -encrypted -hashmethod SHA512
add system user nsadmin 2ff49b91f7ef4dbca779a31ebe3e5d7fefa7d130491ff96f8dc3ad530d7c7e2cbf4895b909a80c0ee545277ce12ffd0a1682a9916ddbf727bf899ce440c97ad1433b13353 -encrypted -hashmethod SHA512 -timeout 9000
add system user nsaudit 200f5aa561f585f4e2bf6ed9f30808c2d7119f66791fe5465f625b318c5db53a75c589a0c4d7d24f2afedc562482ecaa193e51f7597a4408018af78b9366312d2d88f17ff -encrypted -hashmethod SHA512 -externalAuth DISABLED -timeout 900
set rsskeytype -rsstype ASYMMETRIC
set lacp -sysPriority 32768 -mac 00:0d:3a:3a:28:45
set ns hostName ns-vpx0
set interface 0/1 -throughput 0 -bandwidthHigh 0 -bandwidthNormal 0 -intftype "Hyper v" -ifnum 0/1
set interface 1/1 -throughput 0 -bandwidthHigh 0 -bandwidthNormal 0 -intftype "Hyper v" -ifnum 1/1
set interface 1/2 -throughput 0 -bandwidthHigh 0 -bandwidthNormal 0 -intftype "Hyper v" -ifnum 1/2
set interface LO/1 -haMonitor OFF -haHeartbeat OFF -throughput 0 -bandwidthHigh 0 -bandwidthNormal 0 -intftype Loopback -ifnum LO/1
add ns ip6 fe80::20d:3aff:fe3a:2845/64 -scope link-local -type NSIP -vlan 1 -vServer DISABLED -mgmtAccess ENABLED -dynamicRouting ENABLED
# addhanode
add HA node 1 10.78.226.213 -inc ENABLED

add ns ip 10.78.226.244 255.255.255.240 -vServer DISABLED
add ns ip 10.78.226.229 255.255.255.240 -vServer DISABLED

set nd6RAvariables -vlan 1
set ns encryptionParams -method AES256 -keyValue faa3efcb46ea3d41bca9032c68031bfe49cb557778be0b8501555000977469debd091ced6671453f4e27bbc9930dc33d8c69c38462517d9c48ab65bd82817a3562654a94cba0941d78b2a7dd3099aa0d -encrypted -encryptmethod ENCMTHD_3
add ssl profile ns_custom_ssl_profile_secure_frontend -sessReuse ENABLED -sessTimeout 120 -tls1 DISABLED -tls11 DISABLED -denySSLReneg NONSECURE -HSTS ENABLED -maxage 15552000 -IncludeSubdomains YES
set cmp parameter -policyType ADVANCED
add server 168.63.129.16 168.63.129.16
#
add server tc1wpdc10.tech-01.net 10.78.226.4
add service azurelbdnsservice0 168.63.129.16 DNS 53 -gslb NONE -maxClient 0 -maxReq 0 -cip DISABLED -usip NO -useproxyport NO -sp OFF -cltTimeout 120 -svrTimeout 120 -CKA NO -TCPB NO -CMP NO
add service svc-tc1wpdc10.tech-01.net-dns tc1wpdc10.tech-01.net DNS 53 -gslb NONE -maxClient 0 -maxReq 0 -cip DISABLED -usip NO -useproxyport NO -sp OFF -cltTimeout 120 -svrTimeout 120 -CKA NO -TCPB NO -CMP NO
add aaa user user1 -password d7ef392946154005d7ad72d7f3a15f1ac7831c660c0065b21b0e4b73a1ab547e -encrypted -encryptmethod ENCMTHD_3

add aaa group Netscaler_SSLVPN
# sslcertkey
add ssl certKey ns-server-certificate -cert ns-server.cert -key ns-server.key
add ssl certKey "Test CA Root" -cert Test-CA-Root.crt -expiryMonitor DISABLED
add ssl certKey sslvpn.westeurope.cloudapp -cert sslvpn.westeurope.cloudapp.azure.com.crt -key sslvpn.westeurope.cloudapp.azure.com.key -expiryMonitor DISABLED
add ssl certKey AzureSAMLSigningCert -cert AzureSAMLSigningCertificate.cer -passcrypt "wDXU7JH0ktiYSrqMYmLzF77Jir0/ba9b"
link ssl certKey sslvpn.westeurope.cloudapp "Test CA Root"
#
add authentication ldapAction authn-ac-ldaps -serverIP 10.78.226.4 -authTimeout 6 -ldapBase "CN=Users,DC=tech-01,DC=net" -ldapBindDn ns-ldap@tech-01.net -ldapBindDnPassword e0310598036dee34715e591c505dcb158f773b84b60c00a4ecd53904686d969c973dafb7c80f936c0524138c2391c652 -encrypted -encryptmethod ENCMTHD_3 -ldapLoginName userprincipalName -groupAttrName memberOf -subAttributeName cn -authentication DISABLED

add vpn url jump-host-1 "Shared Desktop" "rdp://10.78.226.132" -clientlessAccess ON -applicationtype VPN
add vpn intranetApplication net-10.78.226.128-26-jumphosts TCP 10.78.226.128 -netmask 255.255.255.192 -destPort 3389 -interception TRANSPARENT

add authentication localPolicy authn-pol-local ns_true
add authentication ldapPolicy authn-pol-ldaps ns_true authn-ac-ldaps

set lb parameter -sessionsThreshold 450000
add lb vserver azurelbdnsvserver DNS 0.0.0.0 0 -persistenceType NONE -lbMethod ROUNDROBIN -cltTimeout 120
add lb vserver vsrv-lb-dns DNS 0.0.0.0 0 -persistenceType NONE -cltTimeout 120

set cache parameter -via "NS-CACHE-10.0: 212"

#addvpnvserver
add vpn vserver ng-sslvpn-ssl SSL 13.94.169.255 443 -downStateFlush DISABLED -Listenpolicy NONE

add cs vserver cs-sslvpn-redirect HTTP 13.81.31.61 80 -cltTimeout 180
set aaa parameter -maxAAAUsers 4294967295

# addrpcnode
set ns rpcNode 10.78.226.212 -password 5ac76b352c1db03ca7d64da9cc7727a347c1dd01702de3cc2bb886d2e743ae6afaa4d055c02c96706b42392cfd4f57c4 -encrypted -encryptmethod ENCMTHD_3 -srcIP 10.78.226.212
set ns rpcNode 10.78.226.213 -password afc96517fff6f27b97eaa07a001ead30d2f467ae29e13113fad4f451abe447cffe38618592b3e6678e2ddbc5a369c5d6 -encrypted -encryptmethod ENCMTHD_3 -srcIP 10.78.226.212

bind rewrite policylabel ns_cvpn_v2_url_label ns_cvpn_v2_bypass_url_pol 20000 NEXT
bind cmp global ns_adv_nocmp_xml_ie -priority 8700 -gotoPriorityExpression END -type RES_DEFAULT
bind cmp global ns_adv_nocmp_mozilla_47 -priority 8800 -gotoPriorityExpression END -type RES_DEFAULT
bind cmp global ns_adv_cmp_mscss -priority 8900 -gotoPriorityExpression END -type RES_DEFAULT
bind cmp global ns_adv_cmp_msapp -priority 9000 -gotoPriorityExpression END -type RES_DEFAULT
bind cmp global ns_adv_cmp_content_type -priority 10000 -gotoPriorityExpression END -type RES_DEFAULT
#
add responder action resp-ac-http2https redirect "\"https://\" + HTTP.REQ.HOSTNAME" -responseStatusCode 301
add responder policy resp-pol-http2https true resp-ac-http2https
set cache contentGroup NSFEO -maxResSize 1994752
bind lb vserver azurelbdnsvserver azurelbdnsservice0
bind lb vserver vsrv-lb-dns svc-tc1wpdc10.tech-01.net-dns
#
bind cs vserver cs-sslvpn-redirect -policyName resp-pol-http2https -priority 100 -gotoPriorityExpression END -type REQUEST
add dns nameServer azurelbdnsvserver
set ns diameter -identity netscaler.com -realm com
set subscriber gxInterface -pcrfRealm pcrf.com -servicePathAVP 262099 -servicePathVendorid 3845
set ns tcpbufParam -memLimit 1024
set dns parameter -dns64Timeout 1000
set lb monitor ldns-dns LDNS-DNS -query . -queryType Address
set lb monitor stasecure CITRIX-STA-SERVICE -interval 2 MIN
set lb monitor sta CITRIX-STA-SERVICE -interval 2 MIN
bind service azurelbdnsservice0 -monitorName dns
add route 0.0.0.0 0.0.0.0 10.78.226.209
add route 10.0.0.0 255.0.0.0 10.78.226.241
add route 10.78.226.128 255.255.255.192 10.78.226.241
set ssl parameter -defaultProfile ENABLED
set ssl service vpndbssvc_1339998057 -sslProfile ns_default_ssl_profile_backend
set ssl service nsrnatsip-127.0.0.1-5061 -sslProfile ns_default_ssl_profile_frontend
set ssl service nskrpcs-127.0.0.1-3009 -sslProfile ns_default_ssl_profile_frontend
set ssl service nshttps-::1l-443 -sslProfile ns_default_ssl_profile_frontend
set ssl service nsrpcs-::1l-3008 -sslProfile ns_default_ssl_profile_frontend
set ssl service nshttps-127.0.0.1-443 -sslProfile ns_default_ssl_profile_frontend
set ssl service nsrpcs-127.0.0.1-3008 -sslProfile ns_default_ssl_profile_frontend
set ssl vserver ng-sslvpn-ssl -sslProfile ns_custom_ssl_profile_secure_frontend
#
add authentication samlAction authn-ac-saml-sslvpn -samlIdPCertName AzureSAMLSigningCert -samlRedirectUrl "https://login.microsoftonline.com/7f73ddb0-b379-4171-9354-f82e3068e25a/saml2" -samlRejectUnsignedAssertion OFF -samlIssuerName "https://sslvpn.westeurope.cloudapp.azure.com" -signatureAlg RSA-SHA256 -digestMethod SHA256 -authnCtxClassRef PasswordProtectedTransport -logoutURL "https://login.microsoftonline.com/7f73ddb0-b379-4171-9354-f82e3068e25a/saml2"
add authentication samlAction authn-ac-saml-sslvpn-test -samlRedirectUrl "https://login.microsoftonline.com/7f73ddb0-b379-4171-9354-f82e3068e25a/saml2" -samlRejectUnsignedAssertion OFF -samlIssuerName "https://sslvpn.westeurope.cloudapp.azure.com" -signatureAlg RSA-SHA256 -digestMethod SHA256 -authnCtxClassRef PasswordProtectedTransport -logoutURL "https://login.microsoftonline.com/7f73ddb0-b379-4171-9354-f82e3068e25a/saml2" -logoutBinding REDIRECT
add authentication samlAction authn-ac-saml-sslvpn-test-2 -samlRedirectUrl "https://login.microsoftonline.com/7f73ddb0-b379-4171-9354-f82e3068e25a/saml2" -logoutURL "https://login.microsoftonline.com/7f73ddb0-b379-4171-9354-f82e3068e25a/saml2" -logoutBinding REDIRECT
add authentication samlPolicy authn-pol-saml-sslvpn ns_true authn-ac-saml-sslvpn

add rdp clientprofile rdp-prof -rdpFileName app.rdp
add vpn sessionAction sess-ac-sslvpn -splitDns REMOTE -splitTunnel ON -transparentInterception ON -defaultAuthorizationAction ALLOW -forceCleanup all -SSO ON -ssoCredential PRIMARY -useMIP NS -useIIP SPILLOVER -homePage none -icaProxy OFF -ClientChoices OFF -iipDnsSuffix tech-01.net -clientlessVpnMode DISABLED -WindowsPluginUpgrade Essential -MacPluginUpgrade Essential -LinuxPluginUpgrade Essential
add vpn sessionAction sess-ac-sslvpn-choice -splitTunnel ON -transparentInterception ON -defaultAuthorizationAction ALLOW -useMIP NS -useIIP SPILLOVER -icaProxy OFF -ClientChoices ON -clientlessVpnMode OFF -rdpClientProfileName rdp-prof -WindowsPluginUpgrade Essential -MacPluginUpgrade Essential -LinuxPluginUpgrade Essential
add vpn sessionPolicy sess-pol-sslvpn true sess-ac-sslvpn-choice
add vpn sessionPolicy sess-pol-sslvpn-only true sess-ac-sslvpn
set vpn parameter -forceCleanup none -clientConfiguration all
bind audit syslogGlobal -policyName SETSYSLOGPARAMS_ADV_POL -priority 2000000000
bind audit nslogGlobal -policyName SETNSLOGPARAMS_ADV_POL -priority 2000000000
bind aaa group Netscaler_SSLVPN -intranetApplication net-10.78.226.128-26-jumphosts
bind aaa group Netscaler_SSLVPN -policy sess-pol-sslvpn-only -priority 100 -intranetApplication net-10.78.226.128-26-jumphosts -gotoPriorityExpression NEXT
bind system user nsadmin superuser 101
bind system user nsaudit read-only 100
bind tunnel global ns_tunnel_msdocs -priority 4000
bind tunnel global ns_tunnel_mimetext -priority 6000
bind tm global -policyName SETTMSESSPARAMS_ADV_POL -priority 65534 -gotoPriorityExpression NEXT

bind vpn vserver ng-sslvpn-ssl -portaltheme X1
bind vpn vserver ng-sslvpn-ssl -policy authn-pol-saml-sslvpn -priority 100
bind vpn vserver ng-sslvpn-ssl -policy authn-pol-ldaps -priority 100 -secondary
bind vpn vserver ng-sslvpn-ssl -urlName jump-host-1
bind vpn vserver ng-sslvpn-ssl -intranetApplication net-10.78.226.128-26-jumphosts
bind vpn vserver ng-sslvpn-ssl -policy _cacheTCVPNStaticObjects -priority 10 -gotoPriorityExpression END -type REQUEST -intranetApplication net-10.78.226.128-26-jumphosts
bind vpn vserver ng-sslvpn-ssl -policy _cacheOCVPNStaticObjects -priority 20 -gotoPriorityExpression END -type REQUEST -intranetApplication net-10.78.226.128-26-jumphosts
bind vpn vserver ng-sslvpn-ssl -policy _cacheVPNStaticObjects -priority 30 -gotoPriorityExpression END -type REQUEST -intranetApplication net-10.78.226.128-26-jumphosts
bind vpn vserver ng-sslvpn-ssl -policy _mayNoCacheReq -priority 40 -gotoPriorityExpression END -type REQUEST -intranetApplication net-10.78.226.128-26-jumphosts
bind vpn vserver ng-sslvpn-ssl -policy _cacheWFStaticObjects -priority 10 -gotoPriorityExpression END -type RESPONSE -intranetApplication net-10.78.226.128-26-jumphosts
bind vpn vserver ng-sslvpn-ssl -policy _noCacheRest -priority 20 -gotoPriorityExpression END -type RESPONSE -intranetApplication net-10.78.226.128-26-jumphosts
bind vpn vserver ng-sslvpn-ssl -policy sess-pol-sslvpn -priority 100 -gotoPriorityExpression NEXT -type REQUEST -intranetApplication net-10.78.226.128-26-jumphosts

bind ssl profile ns_default_ssl_profile_frontend -eccCurveName P_256
bind ssl profile ns_default_ssl_profile_frontend -eccCurveName P_384
bind ssl profile ns_default_ssl_profile_frontend -eccCurveName P_224
bind ssl profile ns_default_ssl_profile_frontend -eccCurveName P_521
bind ssl profile ns_default_ssl_profile_frontend -cipherName DEFAULT -cipherPriority 2
bind ssl profile ns_default_ssl_profile_backend -eccCurveName P_256
bind ssl profile ns_default_ssl_profile_backend -eccCurveName P_384
bind ssl profile ns_default_ssl_profile_backend -eccCurveName P_224
bind ssl profile ns_default_ssl_profile_backend -eccCurveName P_521
bind ssl profile ns_default_ssl_profile_backend -cipherName DEFAULT_BACKEND -cipherPriority 2
bind ssl profile ns_default_ssl_profile_secure_frontend -eccCurveName P_256
bind ssl profile ns_default_ssl_profile_secure_frontend -eccCurveName P_384
bind ssl profile ns_default_ssl_profile_secure_frontend -eccCurveName P_224
bind ssl profile ns_default_ssl_profile_secure_frontend -eccCurveName P_521
bind ssl profile ns_default_ssl_profile_secure_frontend -cipherName SECURE -cipherPriority 2
bind ssl profile ns_custom_ssl_profile_secure_frontend -eccCurveName P_256
bind ssl profile ns_custom_ssl_profile_secure_frontend -eccCurveName P_384
bind ssl profile ns_custom_ssl_profile_secure_frontend -eccCurveName P_224
bind ssl profile ns_custom_ssl_profile_secure_frontend -eccCurveName P_521
bind ssl service nsrnatsip-127.0.0.1-5061 -certkeyName ns-server-certificate
bind ssl service nskrpcs-127.0.0.1-3009 -certkeyName ns-server-certificate
bind ssl service nshttps-::1l-443 -certkeyName ns-server-certificate
bind ssl service nsrpcs-::1l-3008 -certkeyName ns-server-certificate
bind ssl service nshttps-127.0.0.1-443 -certkeyName ns-server-certificate
bind ssl service nsrpcs-127.0.0.1-3008 -certkeyName ns-server-certificate
bind ssl vserver ng-sslvpn-ssl -certkeyName sslvpn.westeurope.cloudapp
set ip6TunnelParam -srcIP ::
set ptp -state ENABLE
set ns vpxparam -cpuyield DEFAULT
set ns cqaparam -lr1probthresh 0.00e+00 -lr2probthresh 0.00e+00
set qos parameters -debuglevel 0 -dumpcore 4294967295 -dumpsession 0 -dumpqp 0
set urlfiltering parameter -HoursBetweenDBUpdates 24 -TimeOfDayToUpdateDB 03:00 -MaxNumberOfCloudThreads 4 -CloudKeepAliveTimeout 120000 -CloudServerConnectTimeout 1000 -CloudDBLookupTimeout 2000 -seedDBSizeLevel 1 -LocalDatabaseThreads 1
set videooptimization parameter -RandomSamplingPercentage 0.00e+00
